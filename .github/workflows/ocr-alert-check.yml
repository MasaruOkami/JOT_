name: OCR Health Check (Alert Mail)

on:
  schedule:
    - cron: "*/30 * * * *"  # 30分おき
  workflow_dispatch:

jobs:
  ocr-health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install requests
          sudo apt-get update
          sudo apt-get install -y msmtp ca-certificates gettext-base

      - name: Write msmtp config
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          REPORT_FROM: ${{ secrets.REPORT_FROM }}
        run: |
          set -euo pipefail

          cat > ~/.msmtprc << 'EOF'
          defaults
          auth           on
          tls            on
          tls_starttls   on
          logfile        ~/.msmtp.log

          account        gmail
          host           ${SMTP_HOST}
          port           ${SMTP_PORT}
          user           ${SMTP_USER}
          password       ${SMTP_PASS}
          from           ${REPORT_FROM}

          account default : gmail
          EOF

          envsubst < ~/.msmtprc > ~/.msmtprc.tmp
          mv ~/.msmtprc.tmp ~/.msmtprc
          chmod 600 ~/.msmtprc

          echo "msmtp version:"
          msmtp --version

      - name: Locate script (debug)
        run: |
          set -euo pipefail
          echo "pwd=$(pwd)"
          ls -la
          echo "--- find ocr_alert_check.py ---"
          find . -maxdepth 6 -type f -name "ocr_alert_check.py" -print

          SCRIPT_PATH="$(find . -maxdepth 6 -type f -name 'ocr_alert_check.py' | head -n 1)"
          if [ -z "${SCRIPT_PATH}" ]; then
            echo "ocr_alert_check.py not found"
            exit 2
          fi
          echo "SCRIPT_PATH=${SCRIPT_PATH}" >> $GITHUB_ENV

      - name: Run alert check (ALERT only)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          REPORT_TO: ${{ secrets.REPORT_TO }}
          REPORT_FROM: ${{ secrets.REPORT_FROM }}

          # テスト送信したい場合だけ true にする（普段は消す or false）
          FORCE_SEND_OK: ${{ secrets.FORCE_SEND_OK }}

          # ログ出したい時だけ true
          DEBUG_MSMTP_LOG: ${{ secrets.DEBUG_MSMTP_LOG }}
        run: |
          set -euo pipefail

          echo "Running: python ${SCRIPT_PATH}"
          python "${SCRIPT_PATH}"

      - name: Dump msmtp log (debug)
        if: ${{ always() }}
        env:
          DEBUG_MSMTP_LOG: ${{ secrets.DEBUG_MSMTP_LOG }}
        run: |
          set -euo pipefail
          if [ "${DEBUG_MSMTP_LOG:-}" = "true" ]; then
            echo "----- ~/.msmtp.log -----"
            cat ~/.msmtp.log || true
          else
            echo "DEBUG_MSMTP_LOG is not true -> skip dumping log"
          fi
