name: OCR Health Check (Alert + Daily)

on:
  schedule:
    # 30分おき（異常時のみ通知）
    - cron: "*/30 * * * *"
    # 毎日1回（生存確認メール）※ 0:00 は */30 と被るので 0:05 にずらす
    # JST 09:05 = UTC 00:05
    - cron: "5 0 * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: "alert: 異常時のみ / daily: 毎日送信"
        required: false
        default: "alert"

jobs:
  ocr-health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install requests
          sudo apt-get update
          sudo apt-get install -y msmtp ca-certificates gettext-base

      - name: Decide MODE
        id: mode
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODE="${{ inputs.mode }}"
          else
            # どの cron で起動したかで判定
            if [ "${{ github.event.schedule }}" = "5 0 * * *" ]; then
              MODE="daily"
            else
              MODE="alert"
            fi
          fi

          echo "MODE=${MODE}" | tee -a "$GITHUB_OUTPUT"

      - name: Write msmtp config
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          REPORT_FROM: ${{ secrets.REPORT_FROM }}
        run: |
          set -euo pipefail

          cat > ~/.msmtprc << 'EOF'
          defaults
          auth           on
          tls            on
          tls_starttls   on
          logfile        ~/.msmtp.log

          account        gmail
          host           ${SMTP_HOST}
          port           ${SMTP_PORT}
          user           ${SMTP_USER}
          password       ${SMTP_PASS}
          from           ${REPORT_FROM}

          account default : gmail
          EOF

          envsubst < ~/.msmtprc > ~/.msmtprc.tmp
          mv ~/.msmtprc.tmp ~/.msmtprc
          chmod 600 ~/.msmtprc

          echo "msmtp version:"
          msmtp --version

      - name: Locate script
        run: |
          set -euo pipefail
          echo "pwd=$(pwd)"
          echo "--- find ocr_alert_check.py ---"
          find . -maxdepth 6 -type f -name "ocr_alert_check.py" -print

          SCRIPT_PATH="$(find . -maxdepth 6 -type f -name 'ocr_alert_check.py' | head -n 1)"
          if [ -z "${SCRIPT_PATH}" ]; then
            echo "ocr_alert_check.py not found"
            exit 2
          fi
          echo "SCRIPT_PATH=${SCRIPT_PATH}" >> "$GITHUB_ENV"

      - name: Run alert check
        env:
          MODE: ${{ steps.mode.outputs.MODE }}

          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

          REPORT_TO: ${{ secrets.REPORT_TO }}
          REPORT_FROM: ${{ secrets.REPORT_FROM }}

          # ログ出したい時だけ true
          DEBUG_MSMTP_LOG: ${{ secrets.DEBUG_MSMTP_LOG }}
        run: |
          set -euo pipefail
          echo "MODE=${MODE}"
          echo "Running: python ${SCRIPT_PATH}"
          python "${SCRIPT_PATH}"

      - name: Dump msmtp log (debug)
        if: ${{ always() }}
        env:
          DEBUG_MSMTP_LOG: ${{ secrets.DEBUG_MSMTP_LOG }}
        run: |
          set -euo pipefail
          if [ "${DEBUG_MSMTP_LOG:-}" = "true" ]; then
            echo "----- ~/.msmtp.log -----"
            cat ~/.msmtp.log || true
          else
            echo "DEBUG_MSMTP_LOG is not true -> skip dumping log"
          fi
